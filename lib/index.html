<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>pfpgame</title>
	<meta name="generator" content="Studio 3 http://aptana.com/">
	<meta name="author" content="Neo">
	<script src="core/image.js" type="text/javascript"></script>
	<script src="core/sprite.js" type="text/javascript"></script>
	<script type="text/javascript">
	  var megaman = new Sprite('img/megaman.png', 25, 25);
	  var bg = new pfImage('img/orange_ocean.jpg');

	  var frame = 0;
	  
	  function gameGo()
	  {	    
	    var w = document.getElementById('gameWindow');
      var cxt = w.getContext('2d');
	    cxt.putImageData(bg.slice(), 0, 0);
	    
	    setInterval("animate();", 100);
	    //animate();
	  }
	  
	  function animate()
	  {
	    if(frame > 2)
	     frame = 0;
	     
	    if((megaman.posCurrent.x + megaman.frameWidth) > bg.width())
	      megaman.move(-bg.width(), 0);
	    else
	      megaman.move(3, 0);
	    
	    megaman.setFrame(frame, 0);
	     
	    var newBGSlice = bg.slice(
	      megaman.posCurrent.x, megaman.posCurrent.y,
	      megaman.frameWidth, megaman.frameHeight
	    );
	    
	    var oldBGSlice = bg.slice(
	      megaman.posPrevious.x, megaman.posPrevious.y,
        megaman.frameWidth, megaman.frameHeight
	    );
	    	    
	    var mCurrent = megaman.getCurrentFrame();
	    
	    for(var p = 0; p < mCurrent.data.length; p += 4)
	    {
	      if(mCurrent.data[p + 3] == 0)
	      {
	        mCurrent.data[p] = newBGSlice.data[p];
	        mCurrent.data[p + 1] = newBGSlice.data[p + 1];
	        mCurrent.data[p + 2] = newBGSlice.data[p + 2];
	        mCurrent.data[p + 3] = newBGSlice.data[p + 3];
	      }
	    }
	    
	    var w = document.getElementById('gameWindow');
      var cxt = w.getContext('2d');
      
      //megaman.posCurrent.x = megaman.posCurrent.x + 1;
      
      cxt.putImageData(oldBGSlice,
        megaman.posPrevious.x, megaman.posPrevious.y
      );
      
      cxt.putImageData(mCurrent, 
        megaman.posCurrent.x, megaman.posCurrent.y
      );
      
      //megaman.draw(cxt);
      
      frame = frame + 1;
	  }
	</script>
</head>
<body onload="gameGo();">

  <canvas id="gameWindow" width="640" height="480"/>

</body>
</html>
